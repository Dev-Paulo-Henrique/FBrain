<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital@1&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/google/google-original.svg"
      type="image/x-icon"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scanner</title>
    <style>
      body {
        display: flex;
        font-family: "Roboto", sans-serif;
      }
      li {
        list-style: none;
        margin: 0 0 5px 0;
      }
      ul {
        padding-left: 10px;
      }
    </style>
  </head>
  <body>
    <video
      id="video"
      width="160"
      height="120"
      autoplay
      preload
      loop
      muted
    ></video>
    <ul id="messages"></ul>
    <script
      type="text/javascript"
      src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"
    ></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.9/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.6.9/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyC-95CGASDakQ4u6lo4cegLMoKc878zVsQ",
        authDomain: "notification-37963.firebaseapp.com",
        databaseURL: "https://notification-37963-default-rtdb.firebaseio.com",
        projectId: "notification-37963",
        storageBucket: "notification-37963.appspot.com",
        messagingSenderId: "436853802203",
        appId: "1:436853802203:web:f048b9bdb4998c75eeb8fe",
        measurementId: "G-7GJPQCG664",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase();
      function init() {
        const video = document.getElementById("video");
        var audio = new Audio(
          "https://toqueparacelular.com/wp-content/uploads/2021/03/Redmi-New-Massage.mp3"
        );
        const scanner = new Instascan.Scanner({ video: video });
        Instascan.Camera.getCameras().then((cameras) => {
          scanner.addListener("scan", (content) => {
            const name = JSON.parse(content);
            const finallyName = name.name;
            set(
              ref(database, "users/" + "1B/" + finallyName),
              JSON.parse(content)
            );
            const starCountRef = ref(database, "users/" + "1B/" + finallyName);
            onValue(starCountRef, (snapshot) => {
              const dataName = snapshot.val().name;
              const dataDate = snapshot.val().date;
              if (
                dataDate ===
                new Intl.DateTimeFormat("pt-BR", {
                  day: "2-digit",
                  month: "2-digit",
                  year: "numeric",
                }).format(new Date())
              ) {
                document.getElementById("messages").innerHTML +=
                  "<li>" +
                  `${JSON.stringify(dataName).replace(/[-""]+/g, "")}` +
                  "</li>";
                Swal.fire({
                  position: "top-end",
                  icon: "success",
                  title: "Novo registro",
                  showConfirmButton: false,
                  timer: 1500,
                });
                audio.play();
              } else {
                Swal.fire({
                  position: "top-end",
                  icon: "warning",
                  title: "Atualize seus dados",
                  showConfirmButton: false,
                  timer: 1500,
                });
              }
            });
          });
          if (cameras.length > 0) {
            scanner.start(cameras[0]);
          }
        });
      }
      window.onload = init();
    </script>
  </body>
</html>
