<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Import TensorFlow.js library -->
      <!-- <link rel="icon" type="image/x-icon" href="chrome-extension://nkbihfbeogaeaoehlefnkodbefgpgknn/images/logo/metamask-fox.svg"> -->
    <title>Document</title>
    <style>
        video, #canvas, svg{
            position: absolute;
        }
        svg, path{
            display: flex;
            margin-left: 7%;
            margin-top: 4%;
        }
    </style>
</head>
<body>
  <video id="video" width="160" height="120" autoplay preload loop muted></video>
  <!-- style="filter: grayscale(100%);" -->
  <canvas id="canvas" width="160" height="120"></canvas>
  <canvas id="secondcanvas"  width="100%" height="100%"></canvas>
  <!-- <script src="instascan.min.js"></script> -->
  <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js" ></script>	
    <script src="tracking-min.js"></script>
    <script src="data/face-min.js"></script>
    
    <script>
        function init(){
            const video = document.getElementById('video')
            const canvas = document.getElementById('canvas')
            const context = canvas.getContext('2d')
            var audio = new Audio('https://toqueparacelular.com/wp-content/uploads/2021/03/Redmi-New-Massage.mp3');
            const tracker = new tracking.ObjectTracker('face')
            var secondcanvas = document.querySelector('#secondcanvas');
            var secondcontext = secondcanvas.getContext('2d');
            var link = document.createElement('a');
            const scanner = new Instascan.Scanner({ video: video });
            
            tracking.track('#video', tracker, {camera: true})
            tracker.on('track', event => {
                // console.log(event)
                context.clearRect(0,0,canvas.width, canvas.height)
                event.data.forEach(rect => {
                    // console.log(rect)
                    context.strokeStyle = '#ff0000'
                    context.lineWidth = 2
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height)
                    context.fillText(`x: ${rect.x}, w: ${rect.width}`, rect.x + rect.width + 10, rect.y + 10 )
                    context.fillText(`y: ${rect.y}, h: ${rect.height}`, rect.x + rect.width + 10, rect.y + 20 )
                    // console.log('rosto encontrado')
                    if(rect.width < 50 && rect.height < 50){
                        context.fillText('Aproxime-se', rect.x + rect.width + 10, rect.y + 30)
                    }
                    if(rect.width >= 50 && rect.height >= 50){
                        secondcanvas.height = video.videoHeight;
                        secondcanvas.width = video.videoWidth;
                        secondcontext.drawImage(video, 0, 0);
                        audio.play();
                        canvas.style.display = 'none'
                        link.download = 'Aluno.png';
                        link.href = secondcanvas.toDataURL();
                        sessionStorage.setItem('QR Code', true)
                        // link.click();
                        if(sessionStorage.getItem('QR Code')){
                          Instascan.Camera.getCameras().then(cameras => {
                            scanner.addListener('scan', content => {
                              // alert('Escaneou o conteudo: ' + content);
                              window.open(content, "_blank");
                              video.style.display = 'none'
                            });
                            if (cameras.length > 0) {
                              scanner.start(cameras[0]);
                      console.log(cameras[0]);
                }
              })
                        }
                        document.body.appendChild(link.click());
                        // console.log(event.data)
                      }
                    })
                  })
                }
                window.onload = init()
                </script>
</body>
</html>